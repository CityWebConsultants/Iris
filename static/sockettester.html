<html>
<head>
    
<script src="https://cdn.socket.io/socket.io-1.2.1.js"></script>
<link id="style" rel="stylesheet" href="style.css" />
<link id="hljs-style" rel="stylesheet" href="monokai_sublime.css" type="text/css" />

<script>
    
var socket = io(document.location.origin);
    
socket.on("message", function(data){
    console.log(data);
    printMessage(data);
});
    
document.getElementById("style").setAttribute("href", document.location.origin + "/" + document.getElementById("style").getAttribute("href"));
document.getElementById("hljs-style").setAttribute("href", document.location.origin + "/" + document.getElementById("hljs-style").getAttribute("href"));
    
</script>
    
</head>
    
<body>
    <div id="container">
        <div class="pane" id="settings-pane">
            <h1>Chat</h1>
            <form id="login">
                <label>User id</label><input id="userid" name="userid" />
                <label>Secret key</label><input name="secretkey" />
                <input type="submit" />
            </form>

            <ul id="grouplist"></ul>

            <div id="groupoptions-pane" style="display:none">
                <h2>Group options (warning: prompts)</h2>
                <ul id="globalgroupoptions">
                    <li onclick="groupNew()">Add new group</li>
                </ul>
                <ul id="groupoptions"></ul>
            </div>
        </div>
        <div id="message-display">
            <div id="message-form">
                <form id="sendmessage">
                    <div id="message-container">
                        <label>Message</label><textarea id="message"></textarea>
                    </div>

                    <div id="messageoptions-container">
                        <div class="messageoption">
                            <label>Type</label><select id="messagetype"></select>
                        </div>
                        <div class="messageoption">
                            <input type="submit">
                        </div>
                    </div>
                </form>
            </div>

            <div id="messages">

            </div>
        </div>
    </div>
<script>
    
// Message edit functions

var messageEdit = function (messageid) {
    var newMessage = prompt("New message content: \n(sorry for the limited input field but hey, it's a demo");

    if(newMessage) {
        var xhr = new XMLHttpRequest(),
            params = "messageid=" + messageid + "&userid=" + userid + "&token=" + token + "&messagetype=text" + "&content=" + newMessage;
        xhr.open("POST", document.location.origin + "/message/edit", true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.setRequestHeader("Content-length", params.length);
        xhr.setRequestHeader("Connection", "close");
        xhr.onload = function () {
            if (this.responseText.indexOf('ERROR') !== 0) {
                updateGroupsList();
            } else {
                alert(this.responseText);
            }
        }
        xhr.send(params);
    }
}

var messageRemove = function (messageid) {
    var sureRemove = confirm("Are you sure you want to remove the message?");

    if (sureRemove) {
        var xhr = new XMLHttpRequest(),
            params = "messageid=" + messageid + "&userid=" + userid + "&token=" + token;
        xhr.open("POST", document.location.origin + "/message/remove", true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.setRequestHeader("Content-length", params.length);
        xhr.setRequestHeader("Connection", "close");
        xhr.onload = function () {
            if (this.responseText.indexOf('ERROR') !== 0) {
                updateGroupsList();
            } else {
                alert(this.responseText);
            }
        }
        xhr.send(params);
    }
}

// Group edit functions

var groupNew = function () {
    var groupName = prompt("Group name:");

    if (groupName) {
        var xhr = new XMLHttpRequest(),
            params = "?userid=" + userid + "&token=" + token + "&name=" + groupName + "&members=" + userid;
        xhr.open("POST", document.location.origin + "/group/add", true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.setRequestHeader("Content-length", params.length);
        xhr.setRequestHeader("Connection", "close");
        xhr.onload = function () {
            if (this.responseText.indexOf('ERROR') !== 0) {
                updateGroupsList();
            } else {
                alert(this.responseText);
            }
        }
        xhr.send(params);
    }
}
    
var groupRename = function (groupid) {
    var newGroupName = prompt("New name for group:");

    if (newGroupName) {
        var xhr = new XMLHttpRequest(),
            params = "groupid=" + groupid + "&userid=" + userid + "&token=" + token + "&name=" + newGroupName;
        xhr.open("POST", document.location.origin + "/group/update/name", true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.setRequestHeader("Content-length", params.length);
        xhr.setRequestHeader("Connection", "close");
        xhr.onload = function () {
            if (this.responseText.indexOf('ERROR') !== 0) {
                updateGroupsList();
            } else {
                alert(this.responseText);
            }
        }
        xhr.send(params);
    }
}
    
var groupAddMembers = function (groupid) {
    var member = prompt("Member to add:");

    if (member) {
        var xhr = new XMLHttpRequest(),
            params = "groupid=" + groupid + "&userid=" + userid + "&token=" + token + "&members=" + member;
        xhr.open("POST", document.location.origin + "/group/update/addmember", true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.setRequestHeader("Content-length", params.length);
        xhr.setRequestHeader("Connection", "close");
        xhr.onload = function () {
            if (this.responseText.indexOf('ERROR') !== 0) {
//                console.log(this.responseText);
//                console.log(params);
                updateGroupsList();
            } else {
                alert(this.responseText);
            }
        }
        xhr.send(params);
    }
}

var groupRemoveMembers = function (groupid) {
    var member = prompt("Member to remove:");

    if (member) {
        var xhr = new XMLHttpRequest(),
            params = "groupid=" + groupid + "&userid=" + userid + "&token=" + token + "&members=" + member;
        xhr.open("POST", document.location.origin + "/group/update/removemember", true);
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.setRequestHeader("Content-length", params.length);
        xhr.setRequestHeader("Connection", "close");
        xhr.onload = function () {
            if (this.responseText.indexOf('ERROR') !== 0) {
//                console.log(this.responseText);
//                console.log(params);
                updateGroupsList();
            } else {
                alert(this.responseText);
            }
        }
        xhr.send(params);
    }
}
    
//Switch group
    
var currentgroup = "";
    
var switchgroup = function(group) {
    
    group = group.getAttribute("data-id");
    
    currentgroup = group;
    
    document.getElementById("sendmessage").style.display = "block";
    
    document.getElementById('messages').innerHTML = '';

    // Fill group options

    document.getElementById('groupoptions').innerHTML = '<li onclick="groupAddMembers(\'' + group + '\')" data-groupid="' + group + '">Add member</li>';
    document.getElementById('groupoptions').innerHTML += '<li onclick="groupRemoveMembers(\'' + group + '\')" data-groupid="' + group + '">Remove member</li>';
    document.getElementById('groupoptions').innerHTML += '<li onclick="groupRename(\'' + group + '\')" data-groupid="' + group + '">Rename group</li>';

    // Fetch message history

    var xhr = new XMLHttpRequest();
    xhr.open("GET", document.location.origin + "/fetch/group/messages?userid=" + userid + "&token=" + token + '&groupid=' + group, true);
    xhr.onload = function () {
        if (this.responseText.indexOf('ERROR') !== 0) {
            var messagesList = JSON.parse(this.responseText);
            for (var messages in messagesList) {
//                console.log(messagesList[messages]);
                messagesList[messages].messageid = messagesList[messages]._id;
                printMessage(messagesList[messages]);
            }
        } else {
            alert(this.responseText);
        }
    };
    xhr.send();
};
    
//Send message form

document.getElementById("sendmessage").onsubmit = function(event){
    
    event.preventDefault();
    
    var message = event.target.elements[0].value,
        group = currentgroup,
        messagetype = event.target.elements[1].value,
        msgobject = {to: group, content: {}};
    
    msgobject.content[messagetype] = message;

//    console.log(JSON.stringify(msgobject));
    socket.emit("message", msgobject);
    
};
    
// Let's define some evil global variables. *gets flykicked by Douglas Crockford*
token = '';
userid = '';
    
//Login form

document.getElementById("login").onsubmit = function(event){

    event.preventDefault();

    postform(document.location.origin + "/auth",event,"POST",function(data){

        if(data === "Secret key invalid"){
            alert(data);

        } else {
            userid = document.getElementById("userid").value;

            socket.emit("pair", {userid:userid,token:data});
            token = data;

            document.getElementById("login").style.display = "none";
            document.getElementById("groupoptions-pane").style.display = "block";

            updateGroupsList();

        };

    });

}

// Populate groups list

var updateGroupsList = function () {
    document.getElementById('grouplist').innerHTML = '';

    var xhr = new XMLHttpRequest();
    xhr.open("GET", document.location.origin + "/fetch/groups?userid=" + userid + "&token=" + token, true);
    xhr.onload = function () {

        var groups = JSON.parse(this.responseText);

        groups.forEach(function(element, index){

            var members = [];

            element.members.forEach(function(user){

                members.push(user.userid);

            });

            members = members.join(",");

            document.getElementById("grouplist").insertAdjacentHTML("beforeend", "<li onclick=switchgroup(this) data-id="+element._id+">" + "Name: " + element.name + " (members: " + members +  ")</li>");

        });

    };

    xhr.send();
}

//General form function

var postform = function(url,event,method,callback){
    
    var data = event.target.elements;

    var send = [];

    var i;

    for (i=0; i<data.length; i+=1){

        if(data[i].getAttribute("name")){

        var name = data[i].getAttribute("name"),
            value = data[i].value;

                send.push(encodeURIComponent(name) + '=' + encodeURIComponent(value));
        }
    };

    send = send.join('&').replace(/%20/g, '+');

    var xhr = new XMLHttpRequest();
    xhr.open(method, url, true);

    xhr.onload = function () {
        callback(this.responseText);
    };

    xhr.send(send);

};
    
// Message display function
function printMessage(data) {
//    console.log(JSON.stringify(data));
    for (var content in data.content) {
        if (content === "code") {
            document.getElementById("messages").insertAdjacentHTML("beforeend",'<div class="message"><div class="author">' + data.userid + ':</div><div class="message-edit"> <a href="#" onclick=messageEdit(\'' + data.messageid + '\')>edit</a> <a href="#" onclick=messageRemove(\'' + data.messageid + '\')>remove</a></div><pre class="hljs">' + data.content[content] + "</pre></div>");
        } else {
            document.getElementById("messages").insertAdjacentHTML("beforeend",'<div class ="message"><div class="author">' + data.userid + ':</div><div class="message-edit"> <a href="#" onclick=messageEdit(\'' + data.messageid + '\')>edit</a> <a href="#" onclick=messageRemove(\'' + data.messageid + '\')>remove</a></div>' + data.content[content] + '</div>');
        }

    }
};

// Fill available message types
( function () {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', document.location.origin + '/fetch/messagetypes', true);
    
    xhr.onload = function () {
        var returns = JSON.parse(this.responseText),
            select = document.getElementById('messagetype');

        returns.forEach( function(element, index) {
            var newoption = document.createElement('option');
            newoption.text = element;
            select.add(newoption);
        });

    };
    
    xhr.send();
    
}());

</script>
    
</body>
    
</html>
