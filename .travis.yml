language: node_js
node_js: "5.5"
before_install: 
  - npm install -g grunt-cli jasmine-node pm2
before_script:
install: 
  - sudo apt-get install jq
  - npm install
  - git clone https://github.com/CityWebConsultants/iris-project-template.git
  - cd iris-project-template
  - mongo mysite --eval "db.users.drop()"
  - mongoimport --db mysite --collection users --file fixtures/users.json
  - mongoimport --db mysite --collection pages --file fixtures/pages.json
  - 'if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then REPO_SLUG="$TRAVIS_REPO_SLUG" && REPO_BRANCH="$TRAVIS_BRANCH" else REPO_SLUG=$(curl -s "https://api.github.com/repos/CityWebConsultants/Iris/pulls/315" | jq .head.repo.full_name) && REPO_BRANCH=$(curl -s "https://api.github.com/repos/CityWebConsultants/Iris/pulls/315" | jq .head.ref) fi'
  - echo $REPO_SLUG
  - echo $REPO_BRANCH
  - npm install  --save git+https://github.com/$TRAVIS_REPO_SLUG.git#$TRAVIS_BRANCH
  - npm install --only=dev
  - pm2 start index.js
  - sleep 60
services:
  - mongodb
env: site=default
addons:
  hosts:
    - www.iris.local
