<!DOCTYPE html>
<html>

<head>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

  <script src="/admin/jsonform/deps/jquery.min.js"></script>
  <script src="/admin/jsonform/deps/underscore-min.js"></script>
  <script src="/admin/jsonform/deps/opt/jquery.ui.custom.js"></script>
  <script src="/admin/jsonform/deps/opt/bootstrap-dropdown.js"></script>
  <script src="/admin/jsonform/deps/opt/bootstrap-typeahead.js"></script>
  <script src="/admin/jsonform/deps/opt/bootstrap-tagsinput.min.js"></script>
  <script src="/admin/jsonform/deps/opt/spectrum.js"></script>
  <script src="/admin/jsonform/deps/opt/jquery.transloadit2.js"></script>

  <script src="/admin/jsonform/lib/jsonform.js"></script>

  <link rel="stylesheet" href="/admin/admin.css" />

</head>


<body>

  <h1></h1>

  <form></form>


  <script>
    $(document).ready(function() {

      var fields = {
        "choose": {
          type: "choose"
        },
        "text": {
          "type": "object",
          "title": "Text",
          "properties": {
            "system-name": {
              "type": "string",
              "title": "System name",
              "description": "The name of the field when stored in the database (this can't be changed easily once set)",
              "required": true
            },
            "label": {
              "type": "string",
              "title": "Label"
            },
            "fieldType": {
              "type": "string",
              "title": "Type of value",
              "enum": ["text", "number", "rich text"]
            },
            "description": {
              "type": "textarea",
              "title": "Description"
            },
            "multifield": {
              "type": "boolean",
              "title": "Can this field have multiple entries?"
            },
            "required": {
              "type": "boolean",
              "title": "Is this field required?"
            },
          }
        },
        "longtext": {
          "type": "object",
          "title": "Long text",
          "properties": {
            "system-name": {
              "type": "string",
              "title": "System name",
              "description": "The name of the field when stored in the database (this can't be changed easily once set)",
              "required": true
            },
            "label": {
              "type": "string",
              "title": "Label"
            },
            "fieldType": {
              "type": "string",
              "title": "Type of value",
              "enum": ["text", "number", "rich text"]
            },
            "description": {
              "type": "textarea",
              "title": "Description"
            },
            "multifield": {
              "type": "boolean",
              "title": "Can this field have multiple entries?"
            },
            "required": {
              "type": "boolean",
              "title": "Is this field required?"
            },
          }
        },
        "date": {
          "type": "object",
          "title": "Date",
          "properties": {
            "system-name": {
              "type": "string",
              "title": "System name",
              "description": "The name of the field when stored in the database (this can't be changed easily once set)",
              "required": true
            },
            "label": {
              "type": "string",
              "title": "Label"
            },
            "description": {
              "type": "textarea",
              "title": "Description"
            },
            "multifield": {
              "type": "boolean",
              "title": "Can this field have multiple entries?"
            },
            "required": {
              "type": "boolean",
              "title": "Is this field required?"
            },
          }
        },
        "boolean": {
          "type": "object",
          "title": "Boolean",
          "properties": {
            "system-name": {
              "type": "string",
              "title": "System name",
              "description": "The name of the field when stored in the database (this can't be changed easily once set)",
              "required": true
            },
            "label": {
              "type": "string",
              "title": "Label"
            },
            "description": {
              "type": "textarea",
              "title": "Description"
            }
          }
        },
        "select": {
          "type": "object",
          "title": "options",
          "properties": {
            "system-name": {
              "type": "string",
              "title": "System name",
              "description": "The name of the field when stored in the database (this can't be changed easily once set)",
              "required": true
            },
            "label": {
              "type": "string",
              "title": "Label"
            },
            "options": {
              "type": "array",
              "title": "Options",
              "items": {
                "option": {
                  "type": "string",
                  "title": "option",
                }
              }
            },
            "required": {
              "type": "boolean",
              "title": "Is this field required?"
            },
            "description": {
              "type": "textarea",
              "title": "Description"
            }
          }
        },
        object: {
          "type": "object",
          "title": "options",
          "properties": {
            "system-name": {
              "type": "string",
              "title": "System name",
              "description": "The name of the field when stored in the database (this can't be changed easily once set)",
              "required": true
            },
            "label": {
              "type": "string",
              "title": "Label"
            },
            "required": {
              "type": "boolean",
              "title": "Is this field required?"
            },
            "description": {
              "type": "textarea",
              "title": "Description"
            },
            "subfields": {
              "type": "array",
              "title": "Fields",
              "items": {
                "type": "object",
                "title": "option",
                "properties": {
                  "choose": {

                    type: "choose"

                  }
                }
              }
            },
          }
        }
      };

      var select = "";

      select += "<option>Pick an item</option>";

      var i = 0;

      $.each(fields, function(index, element) {

        if (index !== "choose") {

          fields.object.properties.subfields.items.properties[index] = JSON.parse(JSON.stringify(element));
          select += "<option value='" + i + "'>" + index + "</option>";

          i += 1;

        }

      });

      JSONForm.elementTypes['choose'] = Object.create(JSONForm.elementTypes['text']);
      JSONForm.elementTypes['choose'].template = '<select value="<%= escape(value) %>" name="<%= node.name %>" onchange="chooseField(event)" class="field-collection-select form-control">' + select + '</select>';

      JSONForm.elementTypes['choose'].onInsert = function(e, node) {

        if (node.value) {

          var choice = node.value;

          $("select[name='" + node.name + "']").val(choice);

          var parent = $("select[name='" + node.name + "']").closest("fieldset")
          $(parent).children("fieldset").hide();
          $(parent).children("fieldset").find("*[name]").attr("disabled", "true");
          $(parent).find("fieldset").eq(choice).show().find("*[name]").removeAttr("disabled");

        } else {

          $("select[name='" + node.name + "']").closest("fieldset").children("fieldset").hide();

        }

      };

      window.chooseField = function(e) {

        var choice = e.target.value;

        var parent = $(e.target).closest("fieldset");

        $(parent).children("fieldset").hide();
        $(parent).find("fieldset").find("*[name]").attr("disabled", "true");

        $(parent).find("fieldset").eq(choice).show().find("*[name]").removeAttr("disabled");

      };

      schema.schema.entityname = {
        "type": "string",
        "title": "Entity name",
        "description": "The name of this entity. This cannot be changed.",
        "required": true
      }

      schema.schema.fields = {

        "type": "array",
        "title": "Fields",
        "description": "Fields on this entity type",
        "required": true,
        "items": {
          type: "object",
          "title": "Choose fields",
          "properties": fields
        }
      }


      //Get type from url

      var urlparts = document.location.pathname.split("/");

      window.type = urlparts[urlparts.length - 1];

      $.get("/admin/schema/edit/" + type + "/form", function(data, errors) {

        schema.value = {
          "entityname": type,
          "fields": data
        }

        $('form').jsonForm(schema);

      });

    });

  </script>

  <script>
    var schema = {
      "schema": {},
      "form": ["*", {
        "type": "submit",
        "title": "Submit"
      }],
      onSubmit: function(errors, values) {

        console.log(JSON.stringify(values));

        if (errors) {
          console.error(errors);
        } else {

          values.credentials = {
            "apikey": "letmein",
            "secretkey": "letmein"
          };

          $.post("/schema/edit/"+type, values, function(data, errors) {

            console.log(errors);

          });

        }
      }
    }

  </script>

</body>

</html>
